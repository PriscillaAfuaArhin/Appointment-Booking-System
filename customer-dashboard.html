<!DOCTYPE html>
<html>
<head>
    <title>ðŸ‘¤ Customer Dashboard - Booking System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }
        header { background: #2ecc71; color: white; padding: 20px; border-radius: 10px; }
        .status { display: flex; gap: 20px; margin: 20px 0; }
        .status-card { background: white; padding: 20px; border-radius: 10px; flex: 1; }
        .tabs { margin: 20px 0; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; }
        .tab.active { background: #2ecc71; color: white; }
        .content { display: none; }
        .content.active { display: block; }
        .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 20px; }
        .slot-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .book-btn { width: 100%; padding: 10px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .book-btn:disabled { background: #aaa; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; }
        pre { background: #eee; padding: 10px; margin-top: 20px; }
    </style>
</head>

<body>
<div class="container">

<header>
    <h1>ðŸ‘¤ Customer Dashboard</h1>
    <p>Welcome, Customer</p>
</header>

<div class="status">
    <div class="status-card"><h3>My Bookings</h3><p id="booking-count">0</p></div>
    <div class="status-card"><h3>Available Slots</h3><p id="service-count">0</p></div>
    <div class="status-card"><h3>Upcoming</h3><p id="upcoming-count">0</p></div>
</div>

<div class="tabs">
    <button class="tab active" onclick="switchTab(event,'available')">Find & Book</button>
    <button class="tab" onclick="switchTab(event,'bookings')">My Bookings</button>
</div>

<div id="available" class="content active">
    <h2>Available Time Slots</h2>
    <div id="available-slots" class="slots-grid"></div>
</div>

<div id="bookings" class="content">
    <h2>My Bookings</h2>
    <div id="bookings-list"></div>
</div>

<pre id="output"></pre>

</div>

<script>
/* ================== CONSTANTS ================== */
const API = "http://127.0.0.1:8000";
const PROVIDER_ID = 2;
const SERVICE_ID = 1;
const CUSTOMER_ID = 1;
const DATE = "2026-01-05";

/* ================== INIT ================== */
window.onload = loadCustomerData;

async function loadCustomerData() {
    await loadSlots();
    await loadBookings();
}

/* ================== LOAD SLOTS ================== */
async function loadSlots() {
    const res = await fetch(
        `${API}/slots?provider_id=${PROVIDER_ID}&service_id=${SERVICE_ID}&date=${DATE}`
    );
    const slots = await res.json();
    document.getElementById("service-count").innerText = slots.length;
    displaySlots(slots);
}

function displaySlots(slots) {
    const container = document.getElementById("available-slots");
    container.innerHTML = "";

    if (!slots.length) {
        container.innerHTML = "<p>No available slots</p>";
        return;
    }

    slots.forEach(s => {
        container.innerHTML += `
        <div class="slot-card">
            <p><strong>${s.start_time} - ${s.end_time}</strong></p>
            <button class="book-btn"
                onclick="bookSlot('${s.start_time}','${s.end_time}', this)">
                Book
            </button>
        </div>`;
    });
}

/* ================== BOOK SLOT ================== */
async function bookSlot(start, end, btn) {
    btn.disabled = true;

    try {
        // ðŸ”¥ ROOT FIX: backend expects FULL datetime, not duplicated date
        const payload = {
            provider_id: PROVIDER_ID,
            service_id: SERVICE_ID,
            start_time: start   // already ISO datetime from backend
        };

        const res = await fetch(`${API}/appointments/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();
        showOutput(data);

        if (!res.ok) {
            alert(data.detail || "Booking failed");
            btn.disabled = false;
            return;
        }

        alert("âœ… Booking successful!");
        loadCustomerData();

    } catch (err) {
        console.error(err);
        btn.disabled = false;
    }
}

/* ================== LOAD BOOKINGS ================== */
async function loadBookings() {
    const res = await fetch(`${API}/appointments/my?customer_id=${CUSTOMER_ID}`);
    if (!res.ok) return;

    let data = await res.json();

    // ðŸ”¥ FIX: backend may return single object
    const bookings = Array.isArray(data) ? data : [data];
    displayBookings(bookings);
}

function displayBookings(bookings) {
    const container = document.getElementById("bookings-list");

    if (!bookings.length) {
        container.innerHTML = "<p>No bookings yet</p>";
        return;
    }

    let html = "<table><tr><th>Start</th><th>End</th><th>Status</th></tr>";
    bookings.forEach(b => {
        html += `
            <tr>
                <td>${new Date(b.start_time).toLocaleString()}</td>
                <td>${new Date(b.end_time).toLocaleString()}</td>
                <td>${b.status}</td>
            </tr>`;
    });
    html += "</table>";

    container.innerHTML = html;
    document.getElementById("booking-count").innerText = bookings.length;
    document.getElementById("upcoming-count").innerText = bookings.length;
}

/* ================== UI ================== */
function switchTab(e, id) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
    e.target.classList.add("active");
    document.getElementById(id).classList.add("active");
}

function showOutput(data) {
    document.getElementById("output").textContent =
        JSON.stringify(data, null, 2);
}
</script>
</body>
</html>
